<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unity AR Example with AlvaAR</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
        }
        #webcam {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }
        #unityContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }
        #unity-canvas {
            width: 100%;
            height: 100%;
        }
        #loading-cover {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Webcam Video Element -->
    <video id="webcam" autoplay playsinline muted></video>

    <!-- Unity Canvas Container -->
    <div id="unityContainer">
        <!-- Unity canvas will be inserted here -->
    </div>

    <script type="module">
        import { AlvaAR } from './alva_ar.js';
        import { onFrame } from './utils.js';

        // Access the user's webcam
        async function startWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
                const videoElement = document.getElementById('webcam');
                videoElement.srcObject = stream;
                await videoElement.play();

                const webcamCanvas = document.createElement("canvas");
                document.body.appendChild(webcamCanvas); // Append the webcam canvas to body
                webcamCanvas.id = "webcam-canvas"; // ID for the webcam canvas
                const ctx = webcamCanvas.getContext('2d', { alpha: false, desynchronized: true });
                if (!ctx) {
                    console.error('Failed to get 2D context');
                    return;
                }

webcamCanvas.width = videoElement.videoWidth;
webcamCanvas.height = videoElement.videoHeight;

const alva = await AlvaAR.Initialize(webcamCanvas.width, webcamCanvas.height);

console.log('Video width:', videoElement.videoWidth, 'Video height:', videoElement.videoHeight);

                onFrame(() => {
                    ctx.clearRect(0, 0, webcamCanvas.width, webcamCanvas.height);
ctx.drawImage(videoElement, 0, 0, videoElement.videoWidth, videoElement.videoHeight, 0, 0, webcamCanvas.width, webcamCanvas.height);

                    const frame = ctx.getImageData(0, 0, webcamCanvas.width, webcamCanvas.height);
console.log('Frame width:', frame.width, 'Frame height:', frame.height);


                    const pose = alva.findCameraPose(frame);

                    if (pose) {
                        // Send pose data to Unity
                        if (typeof unityInstance !== 'undefined') {
var dataString = JSON.stringify(pose);
                            unityInstance.SendMessage('CameraPoseManager', 'ReceiveCameraPose', dataString);
             console.log('data sent!', dataString );
                        }
                    }
                }, 30);
            } catch (err) {
                console.error("Error accessing webcam: ", err);
            }
        }

        // Initialize Unity WebGL
        function initializeUnity() {
            const script = document.createElement("script");
            script.src = loaderUrl;
            script.onload = () => {
                createUnityInstance(canvas, config, (progress) => {
                    spinner.style.display = "none";
                    progressBarEmpty.style.display = "";
                    progressBarFull.style.width = `${100 * progress}%`;
                }).then((unityInstance) => {
                    window.unityInstance = unityInstance;
                    loadingCover.style.display = "none";

                    // Start webcam once Unity is fully initialized
                    startWebcam();
                }).catch((message) => {
                    alert(message);
                });
            };
            document.body.appendChild(script);
        }

        // Unity loading process with splash screen handling
        window.onload = () => {
            // Initialize Unity first, and once Unity is ready, start the webcam
            initializeUnity();
        };
    </script>

    <script>
        const hideFullScreenButton = "true";
        const buildUrl = "Build";
        const loaderUrl = buildUrl + "/Build.loader.js";
        const config = {
            dataUrl: buildUrl + "/Build.data",
            frameworkUrl: buildUrl + "/Build.framework.js",
            codeUrl: buildUrl + "/Build.wasm",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "DefaultCompany",
            productName: "alvaarintegr",
            productVersion: "0.1",
        };

        const container = document.querySelector("#unityContainer");
        const canvas = document.createElement("canvas");
        canvas.id = "unity-canvas";
        container.appendChild(canvas);

        const loadingCover = document.createElement("div");
        loadingCover.id = "loading-cover";
        container.appendChild(loadingCover);

        const progressBarEmpty = document.createElement("div");
        progressBarEmpty.id = "unity-progress-bar-empty";
        container.appendChild(progressBarEmpty);

        const progressBarFull = document.createElement("div");
        progressBarFull.id = "unity-progress-bar-full";
        progressBarEmpty.appendChild(progressBarFull);

        const fullscreenButton = document.createElement("button");
        fullscreenButton.id = "unity-fullscreen-button";
        fullscreenButton.innerText = "Fullscreen";
        container.appendChild(fullscreenButton);

        const spinner = document.createElement("div");
        spinner.className = 'spinner';
        container.appendChild(spinner);

        loadingCover.style.display = "";

        const script = document.createElement("script");
        script.src = loaderUrl;
        script.onload = () => {
            createUnityInstance(canvas, config, (progress) => {
                spinner.style.display = "none";
                progressBarEmpty.style.display = "";
                progressBarFull.style.width = `${100 * progress}%`;
            }).then((unityInstance) => {
                window.unityInstance = unityInstance;
                loadingCover.style.display = "none";
            }).catch((message) => {
                alert(message);
            });
        };
        document.body.appendChild(script);
    </script>
</body>
</html>
