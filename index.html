<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unity AR Example with AlvaAR</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
        }

        #webcam {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        #unityContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        #unity-canvas {
            width: 100%;
            height: 100%;
        }

        #loading-cover {
            display: none;
        }
    </style>
</head>
<body>

    <video id="webcam" autoplay playsinline muted></video>

    <div id="unityContainer">

    </div>

    <script type="module">
        import { AlvaAR } from './alva_ar.js';
        import { onFrame } from './utils.js';


        async function startWebcam() {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { width: { min: 1024, ideal: 1280, max: 1920 }, height: { min: 576, ideal: 720, max: 1080 }, facingMode: 'environment' }, audio: false });
            const videoElement = document.getElementById('webcam');
            videoElement.srcObject = stream;
            await videoElement.play();

            const webcamCanvas = document.createElement("canvas");
            document.body.appendChild(webcamCanvas);
            webcamCanvas.id = "webcam-canvas";
            const ctx = webcamCanvas.getContext('2d', { alpha: false, desynchronized: true });

            if (!ctx) {
                console.error('Failed to get 2D context');
                return;
            }

            webcamCanvas.width = videoElement.videoWidth;
            webcamCanvas.height = videoElement.videoHeight;

            const alva = await AlvaAR.Initialize(webcamCanvas.width, webcamCanvas.height);


            onFrame(() => {
                ctx.clearRect(0, 0, webcamCanvas.width, webcamCanvas.height);
                ctx.drawImage(videoElement, 0, 0, videoElement.videoWidth, videoElement.videoHeight, 0, 0, webcamCanvas.width, webcamCanvas.height);

                const frame = ctx.getImageData(0, 0, webcamCanvas.width, webcamCanvas.height);

                const pose = alva.findCameraPose(frame);

                if (pose) {
                    var dataString = JSON.stringify(pose);
                    unityInstance.SendMessage('CameraPoseManager', 'ReceiveCameraPose', dataString);
                }
                else {
                    const dots = alva.getFramePoints();

                    for (const p of dots) {
                        ctx.fillStyle = 'white';
                        ctx.fillRect(p.x, p.y, 2, 2);
                    }
                }
            }, 30);
        }

        function initializeUnity() {
            const script = document.createElement("script");
            script.src = loaderUrl;
            script.onload = () => {
                createUnityInstance(canvas, config, (progress) => {
                    spinner.style.display = "none";
                    progressBarEmpty.style.display = "";
                    progressBarFull.style.width = `${100 * progress}%`;
                }).then((unityInstance) => {
                    window.unityInstance = unityInstance;
                    loadingCover.style.display = "none";

                    startWebcam();
                }).catch((message) => {
                    alert(message);
                });
            };
            document.body.appendChild(script);
        }

        window.onload = () => {
            initializeUnity();
        };
    </script>

    <script>
        const hideFullScreenButton = "true";
        const buildUrl = "Build";
        const loaderUrl = buildUrl + "/Build.loader.js";
        const config = {
            dataUrl: buildUrl + "/Build.data",
            frameworkUrl: buildUrl + "/Build.framework.js",
            codeUrl: buildUrl + "/Build.wasm",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "DefaultCompany",
            productName: "alvaarintegr",
            productVersion: "0.1",
        };

        const container = document.querySelector("#unityContainer");
        const canvas = document.createElement("canvas");
        canvas.id = "unity-canvas";
        container.appendChild(canvas);

        const loadingCover = document.createElement("div");
        loadingCover.id = "loading-cover";
        container.appendChild(loadingCover);

        const progressBarEmpty = document.createElement("div");
        progressBarEmpty.id = "unity-progress-bar-empty";
        container.appendChild(progressBarEmpty);

        const progressBarFull = document.createElement("div");
        progressBarFull.id = "unity-progress-bar-full";
        progressBarEmpty.appendChild(progressBarFull);

        const spinner = document.createElement("div");
        spinner.className = 'spinner';
        container.appendChild(spinner);

        loadingCover.style.display = "";

        const script = document.createElement("script");
        script.src = loaderUrl;
        script.onload = () => {
            createUnityInstance(canvas, config, (progress) => {
                spinner.style.display = "none";
                progressBarEmpty.style.display = "";
                progressBarFull.style.width = `${100 * progress}%`;
            }).then((unityInstance) => {
                window.unityInstance = unityInstance;
                loadingCover.style.display = "none";
            }).catch((message) => {
                alert(message);
            });
        };
        document.body.appendChild(script);
    </script>
</body>
</html>
