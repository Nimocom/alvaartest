<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unity AR Example with AlvaAR</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
        }

        #webcam {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        #unityContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        #unity-canvas {
            width: 100%;
            height: 100%;
        }

        #loading-cover {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Webcam Video Element -->
    <div id="webcam"></div>

    <!-- Unity Canvas Container -->
    <div id="unityContainer">
        <!-- Unity canvas will be inserted here -->
    </div>

    <script type="module">
        import { AlvaAR } from './alva_ar.js';
        import { Camera, onFrame, resize2cover } from './utils.js';

        // Access the user's webcam
        async function main() {

            const config = {
                video: {
                    facingMode: 'environment',
                    aspectRatio: 16 / 9,
                    width: { ideal: 1280 }
                },
                audio: false
            }

            const $container = document.getElementById('webcam');
            const $canvas = document.createElement('canvas');

            async function calculatePose(media) {

                const $video = media.el;

                const size = resize2cover($video.videoWidth, $video.videoHeight, $container.clientWidth, $container.clientHeight);

                $canvas.width = $container.clientWidth;
                $canvas.height = $container.clientHeight;
                $video.style.width = size.width + 'px';
                $video.style.height = size.height + 'px';

                const ctx = $canvas.getContext('2d', { alpha: false, desynchronized: true });
                const alva = await AlvaAR.Initialize($canvas.width, $canvas.height);

                $container.appendChild($canvas);

                onFrame(() => {
                    ctx.clearRect(0, 0, $canvas.width, $canvas.height);
                    ctx.drawImage($video, 0, 0, $video.videoWidth, $video.videoHeight, size.x, size.y, size.width, size.height);

                    const frame = ctx.getImageData(0, 0, $canvas.width, $canvas.height);

                    const pose = alva.findCameraPose(frame);

                    if (pose) {
                        // Send pose data to Unity
                        if (typeof unityInstance !== 'undefined') {
                            var dataString = JSON.stringify(pose);
                            unityInstance.SendMessage('CameraPoseManager', 'ReceiveCameraPose', dataString);
                        }
                    }
                }, 30);
            }

            setTimeout(() => {
                Camera.Initialize(config).then(media => calculatePose(media)).catch(error => alert('Camera ' + error));
            }, 1000);
        }

        // Initialize Unity WebGL
        function initializeUnity() {
            const script = document.createElement("script");
            script.src = loaderUrl;
            script.onload = () => {
                createUnityInstance(canvas, config, (progress) => {
                    spinner.style.display = "none";
                    progressBarEmpty.style.display = "";
                    progressBarFull.style.width = `${100 * progress}%`;
                }).then((unityInstance) => {
                    window.unityInstance = unityInstance;
                    loadingCover.style.display = "none";

                    main();
                }).catch((message) => {
                    alert(message);
                });
            };
            document.body.appendChild(script);
        }

        // Unity loading process with splash screen handling
        window.onload = () => {
            // Initialize Unity first, and once Unity is ready, start the webcam
            initializeUnity();
        };



    </script>

    <script>
        const hideFullScreenButton = "true";
        const buildUrl = "Build";
        const loaderUrl = buildUrl + "/Build.loader.js";
        const config = {
            dataUrl: buildUrl + "/Build.data",
            frameworkUrl: buildUrl + "/Build.framework.js",
            codeUrl: buildUrl + "/Build.wasm",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "DefaultCompany",
            productName: "alvaarintegr",
            productVersion: "0.1",
        };

        const container = document.querySelector("#unityContainer");
        const canvas = document.createElement("canvas");
        canvas.id = "unity-canvas";
        container.appendChild(canvas);

        const loadingCover = document.createElement("div");
        loadingCover.id = "loading-cover";
        container.appendChild(loadingCover);

        const progressBarEmpty = document.createElement("div");
        progressBarEmpty.id = "unity-progress-bar-empty";
        container.appendChild(progressBarEmpty);

        const progressBarFull = document.createElement("div");
        progressBarFull.id = "unity-progress-bar-full";
        progressBarEmpty.appendChild(progressBarFull);

        const fullscreenButton = document.createElement("button");
        fullscreenButton.id = "unity-fullscreen-button";
        fullscreenButton.innerText = "Fullscreen";
        container.appendChild(fullscreenButton);

        const spinner = document.createElement("div");
        spinner.className = 'spinner';
        container.appendChild(spinner);

        loadingCover.style.display = "";

        const script = document.createElement("script");
        script.src = loaderUrl;
        script.onload = () => {
            createUnityInstance(canvas, config, (progress) => {
                spinner.style.display = "none";
                progressBarEmpty.style.display = "";
                progressBarFull.style.width = `${100 * progress}%`;
            }).then((unityInstance) => {
                window.unityInstance = unityInstance;
                loadingCover.style.display = "none";
                console.log('done!');
            }).catch((message) => {
                alert(message);
            });
        };
        document.body.appendChild(script);
    </script>
</body>
</html>
